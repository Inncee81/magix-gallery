<div class="pr pr140">
    <div mx-view="examples/subs?list={{@[{
        name: '需求背景',
        key: viewId + '_bg'
    }, {
        name: '关于实现',
        key: viewId + '_implement',
        subs: [{
            name: '几个重点',
            key: viewId + '_points'
        }, {
            name: '具体操作步骤',
            key: viewId + '_steps'
        }]
    }]}}"></div>

    <mx-title.second id="{{=viewId}}_bg"
        content="需求背景"/>
    <div class="mb40">
        <div class="line"><span class="num">1.</span>为了提升平台与客户的粘性，增强运营策略转化率，提升营销投放效率，阿里妈妈打造全新营销顾问平台mama club，为客户提供批量运营下的专属顾问，一站式解决投放过程中数据、资源、策略、代理、培训等问题。</div>
        <div class="line"><span class="num">2.</span>mama club 需要作为通用模块嵌入到阿里妈妈的四大广告投放系统直通车、钻展、超级推荐和品销宝中，不同平台中需要<span class="color-brand">以该平台品牌色展示</span>。</div>
        <div class="pl20 pt20"><img src="https://img.alicdn.com/tfs/TB1dXhCXbH1gK0jSZFwXXc7aXXa-855-628.png" /></div>
    </div>

    <mx-title.second id="{{=viewId}}_implement"
        content="关于实现"
        tip="以下以一个简单示例说明 Magix 如何实现跨项目公用 view"/>
    <div class="tt" id="{{=viewId}}_points">一、几个重点</div>
    <div class="mb40">
        <div class="line"><span class="num">1.</span>使用&nbsp;Magix&nbsp;提供的&nbsp;vframe&nbsp;功能，允许项目间类似&nbsp;iframe&nbsp;那样引用对方的&nbsp;view。该功能支持把复杂的项目拆分成n个子项目进行维护；</div>
        <div class="line"><span class="num">2.</span>子项目中的&nbsp;view&nbsp;被渲染在宿主项目时，使用<span class="color-brand">宿主项目</span>里的组件（project/gallery/）以及品牌色；</div>
        <div class="line"><span class="num">3.</span>宿主项目<span class="color-brand">按需加载</span>子项目&nbsp;view，首次访问到子view页面时才加载子view资源；</div>
        <div class="line"><span class="num">4.</span>子项目中界面显示所需要的相关颜色，会由&nbsp;/gallery/mx-style/&nbsp;统一提供，自己在&nbsp;view&nbsp;定制的样式请使用<span class="color-brand">&nbsp;css变量&nbsp;</span>进行改造；</div>
        <div class="line mb10"><span class="num">5.</span>关于包名的约定，&nbsp;seajs&nbsp;或&nbsp;requirejs&nbsp;需要配置一个包名来使用某个目录下的js文件，指向不同目录下的包名不能同名。这要求我们在开发新项目时，<span class="color-brand">使用新项目的名称来做为包名</span>，不能再像以前那样使用统一的app名称；</div>
        <pre class="tip-content ml20 mb10">
seajs.config({
    paths: {
        zuanshi: '/app', //主项目
        cross1: '//g.alicdn.com/mm/cross1/20190705.161857.184/cross1' //被加载进来的子项目
    }
});</pre>
        <div class="line mb10"><span class="num">6.</span>关于目录结构的约定，宿主项目和子项目保持同样的目录结构，详细说明参见<a href="#!/all/pro/init" class="color-brand">10分钟快速上手</a></div>
        <pre class="tip-content ml20 mb10">
- project
- src
    - project
        - assets
        - chartpark
        - dataplus
        - gallery
        - gallery-local
        - services
        - views
        prepare.ts
        view.ts
        menu.ts
    - lib
    boot.ts</pre>
    </div>
    <div class="tt" id="{{=viewId}}_steps">二、具体操作步骤</div>
    <div>
        <div class="line mb10"><span class="num">1.</span>项目A中有通用模块“页面1”和“页面2”</div>
        <div class="pl20 mb10">
            <iframe sandbox="allow-forms allow-popups allow-pointer-lock allow-same-origin allow-scripts" src="https://mo.m.taobao.com/page_201806071452566" class="iframe"
                width="100%" 
                height="660" 
                frameborder="0"
                scrolling="no" 
                marginheight="0" 
                marginwidth="0" 
                border="0"></iframe>
        </div>
        <div class="line mb10">
            <div class="num">2.</div>
            <div>跨项目mount的时候，子项目需要使用宿主项目的组件和品牌色；</div>
            <div>如果子模块有单独的样式，请使用&nbsp;css变量&nbsp;（应用宿主项目中的变量定义，组件里mx-style/_group.less；本地覆盖assets/group_override.less）替代&nbsp;less&nbsp;变量；具体示例如下：</div>
        </div>
        <div class="pl20 mb10">
            <div class="tip-content">
                <pre class="inline">
&lt;!-- group_override.less --&gt;
:root&#123;
    --color-brand: #4ca26f;
    --color-brand-vs: #ffe066;
&#125;
        
&lt;!-- 页面1的样式 --&gt;
.demo&#123;
    margin-bottom: 20px;
    padding: 20px;
    background-color: </pre><pre class="inline color-brand">var(--color-bg);</pre><pre>
&#125;</pre>
            </div>
        </div>
        <div class="line">
            <div class="num">3.</div>
            <div>项目B作为宿主项目需要加载这两个模块</div>
            <div>页面1：直接完整加载</div>
            <div>页面2：其中只需要加载子模块2和子模块3，需要传参到子项目view</div>
        </div>
        <div class="line mb10"><span class="num">4.</span>在宿主项目的&nbsp;boot.ts&nbsp;中加入子项目的包配置</div>
        <div class="pl20 mb10">
            <div class="tip-content">
                <pre>seajs.config({
    paths: {
        //主项目配置好要加载的子项目的包名</pre><pre class="color-brand">
        cross1: '//g.alicdn.com/mm/cross1/20190705.161857.184/cross1',</pre><pre>
        [projectName]: src + '/' + projectName
    }
});

seajs.use(['magix'], (Magix) => {
    Magix.config({
        //主项目需要配置子项目的接口的host</pre><pre class="color-brand">
        'cross1.api.host': '//mo.m.taobao.com',</pre><pre>
        projectName
    })
})</pre>
            </div>
        </div>
        <div class="line mb10"><span class="num">5.</span>模块直接加载或者只需传递一些固定参数的时候，直接在&nbsp;menu.ts&nbsp;中配置路径即可</div>
        <div class="pl20 mb10">
            <div class="tip-content">
                <pre>let Menus = [{
    has: true,
    name: '导航菜单',
    path: '/example/path1',
    subs: [{
        name: '跨项目加载view',
        thirds: [{
            has: true,
            name: '页面1',</pre><pre class="color-brand">
            viewPath: 'cross1/views/pages',  //指向子项目的包路径
            path: '/example/path1', //子项目页面路径</pre><pre>
            icon: '&#38;&#35;xe64f;'
        }, {
            has: true,
            name: '页面2',</pre><pre class="color-brand">
            viewPath: 'cross1/views/pages', //指向子项目的包路径
            viewData: { //传入子项目页面的viewData
                filters: [2, 3]
            },
            path: '/example/path2', //子项目页面路径</pre><pre>
            icon: '&#38;&#35;xe64f;'
        }]
    }]
}]</pre>
            </div>
        </div>
        <div class="line mb10"><span class="num">6.</span>改造入口&nbsp;default&nbsp;，加载&nbsp;view&nbsp;前增加&nbsp;prepare&nbsp;检测，实现按需加载</div>
        <div class="pl20 mb10">
            <div class="tip-content">
                <pre>
module.exports = View.extend({
    tmpl: '@default.html',
    init() {
        this.observeLocation({
            path: true
        });
    },
    prepare(info) {
        if (!info.xsite && !info._processed) {
            let vpath = info.viewPath;
            let pkg = vpath.substring(0, vpath.indexOf('/'));
            let projectName = Magix.config('projectName');

            // 自动检测页面指向的包路径和本项目包路径是否一致
            // 不一致则为跨项目view，首次进入子view页面加载响应资源
            if (pkg != projectName) {
                info.xsite = pkg;
            }
            info._processed = true;
        }
        if (info.xsite) {
            if (info._loaded) {
                return Promise.resolve();
            }
            return new Promise((resolve, reject) => {
                seajs.use(`${info.xsite}/prepare`, this.wrapAsync(P => {
                    info._loaded = true;
                    P().then(resolve, reject);
                }));
            });
        }
        return Promise.resolve();
    },
    render() {
        $(window).scrollTop(0);
        let that = this;
        let loc = Router.parse();
        let path = loc.path;

        let routes = Magix.config('routes');
        let pathInfo = routes[path] || {};
        that.prepare(pathInfo).then(() => {
            that.updater.digest({
                path,
                pathInfo
            });
        });
    }
});</pre>
            </div>
        </div>
        <div class="line mb10"><span class="num">7.</span>宿主项目具体具体展现如下</div>
        <div class="pl20">
            <iframe sandbox="allow-forms allow-popups allow-pointer-lock allow-same-origin allow-scripts" src="https://mo.m.taobao.com/page_201809162348244" class="iframe"
                width="100%" 
                height="660" 
                frameborder="0"
                scrolling="no" 
                marginheight="0" 
                marginwidth="0" 
                border="0"></iframe>
        </div>
    </div>
</div>
    